# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Multi-stage build for production (CPU 2 / RAM 4GB 최적화)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Stage 1: Build (의존성 설치)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
FROM python:3.11-slim AS builder

WORKDIR /build

# 빌드 도구 설치 (최소한)
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# uv 설치 (pip보다 10-100배 빠름)
RUN pip install --no-cache-dir uv

# requirements 복사 및 설치
COPY requirements.txt ./
RUN uv pip install --system --no-cache -r requirements.txt

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Stage 2: Runtime (최소화된 실행 환경)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
FROM python:3.11-slim

# 비root 사용자 생성
RUN useradd -m -u 1000 fastapi && \
    mkdir -p /app /chroma_data && \
    chown -R fastapi:fastapi /app /chroma_data

WORKDIR /app

# 빌드 스테이지에서 Python 패키지 복사
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# 애플리케이션 코드 복사
COPY --chown=fastapi:fastapi app ./app
COPY --chown=fastapi:fastapi scripts ./scripts

# 비root 사용자로 전환
USER fastapi

# Python 최적화 옵션
# - PYTHONUNBUFFERED: 로그 즉시 출력
# - PYTHONDONTWRITEBYTECODE: .pyc 파일 생성 안함 (디스크 절약)
# - PYTHONHASHSEED: 해시 재현성
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONHASHSEED=random \
    PYTHONPATH=/app

# Uvicorn worker 설정 (CPU 2코어 최적화)
# - workers: CPU 코어 수 (2)
# - worker-class: uvicorn.workers.UvicornWorker
ENV UVICORN_WORKERS=2 \
    UVICORN_HOST=0.0.0.0 \
    UVICORN_PORT=8000

EXPOSE 8000

# Uvicorn 실행 (프로덕션 모드 - reload 비활성화)
CMD ["sh", "-c", "uvicorn app.main:app --host $UVICORN_HOST --port $UVICORN_PORT --workers $UVICORN_WORKERS --no-access-log"]
